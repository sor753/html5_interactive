<!DOCTYPE html>
<html>

<head>
	<title>EaselJS Sample - ForceMap Arrows</title>
	<script>var createjs = window;</script> <!-- 名前空間をグローバルに変更 -->
	<script src="http://code.createjs.com/easeljs-0.6.0.min.js"></script>
	<script>

		var NUM_PARTICLE = 1000;
		var arrowImage;
		var forceMapImage;
		var forceMapCanvas;
		var forceMapIndexA = 0;
		var forceMapIndexB = 1;
		var stage;
		var particleList = [];

		function init() {
			forceMapImage = new Image();
			forceMapImage.onload = initForceMap;
			forceMapImage.src = "imgs/forcemap.png";
		}

		function initForceMap() {
			var forceMapElement = document.createElement("canvas");
			forceMapElement.setAttribute("width", forceMapImage.width);
			forceMapElement.setAttribute("height", forceMapImage.height);

			forceMapCanvas = forceMapElement.getContext("2d");
			forceMapCanvas.drawImage(forceMapImage, 0, 0);

			arrowImage = new Image();
			arrowImage.onload = initParticles;
			arrowImage.src = "imgs/arrow.png";
			console.log(arrowImage);
		}

		function initParticles() {
			canvas = document.getElementById("myCanvas");
			stage = new Stage(canvas);

			for (i = 0; i < NUM_PARTICLE; i++) {
				var arrow = new Arrow(arrowImage, Math.random() * 960 >> 0, Math.random() * 540 >> 0);
				console.log(arrow.initialize);
				stage.addChild(arrow);
				particleList[i] = arrow;
			}

			Ticker.setFPS(60);
			Ticker.addListener(window);
			setInterval(resetForceMapIndex, 1000);
		}

		function tick() {
			for (var i = 0; i < particleList.length; i++) {
				var arrow = particleList[i];
				var data = forceMapCanvas.getImageData(arrow.x >> 1, arrow.y >> 1, 1, 1);
				arrow.step(data.data[forceMapIndexA], data.data[forceMapIndexB]);
			}
			stage.update();
		}

		function resetForceMapIndex() {
			var indexArr = [0, 1, 2];
			forceMapIndexA = indexArr[indexArr.length * Math.random() >> 0];
			forceMapIndexB = indexArr[indexArr.length * Math.random() >> 0];
		}


		// (function (window) {
		// 	function Arrow(imageOrUri, x, y) {
		// 		this.x = x;
		// 		this.y = y;
		// 		this.vx = 0;
		// 		this.vy = 0;
		// 		this.ax = 0;
		// 		this.ay = 0;
		// 		this.initialize(imageOrUri);
		// 		this.regX = 10;
		// 		this.regY = 10;
		// 	}

		// 	var p = Arrow.prototype = new Bitmap();

		// 	p.step = function (colorA, colorB) {
		// 		this.ax += (colorA - 128) * .0005;
		// 		this.ay += (colorB - 128) * .0005;
		// 		this.vx += this.ax;
		// 		this.vy += this.ay;
		// 		this.x += this.vx;
		// 		this.y += this.vy;

		// 		this.rotation = Math.atan2(this.vy, this.vx) * 180 / Math.PI;

		// 		this.ax *= .96;
		// 		this.ay *= .96;
		// 		this.vx *= .92;
		// 		this.vy *= .92;

		// 		(this.x > 960) ? this.x = 0 : (this.x < 0) ? this.x = 960 : 0;
		// 		(this.y > 540) ? this.y = 0 : (this.y < 0) ? this.y = 540 : 0;
		// 	};
		// 	window.Arrow = Arrow;
		// }(window));
		function Arrow(imageOrUri, x, y) {
			this.x = x;
			this.y = y;
			this.vx = 0;
			this.vy = 0;
			this.ax = 0;
			this.ay = 0;
			this.initialize(imageOrUri);
			this.regX = 10;
			this.regY = 10;
		}

		var p = Arrow.prototype = new Bitmap();

		p.step = function (colorA, colorB) {
			this.ax += (colorA - 128) * .0005;
			this.ay += (colorB - 128) * .0005;
			this.vx += this.ax;
			this.vy += this.ay;
			this.x += this.vx;
			this.y += this.vy;

			this.rotation = Math.atan2(this.vy, this.vx) * 180 / Math.PI;

			this.ax *= .96;
			this.ay *= .96;
			this.vx *= .92;
			this.vy *= .92;

			(this.x > 960) ? this.x = 0 : (this.x < 0) ? this.x = 960 : 0;
			(this.y > 540) ? this.y = 0 : (this.y < 0) ? this.y = 540 : 0;
		};
		window.Arrow = Arrow;

	</script>
</head>

<body onload="init();" style="background-color:#EEEEEE">
	<canvas id="myCanvas" width="960" height="540" style="background-color:#FFFFFF"></canvas>
</body>

</html>
